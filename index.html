<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEURAL_ARCHITECT_PREMIORBIT++++ v14.0 - Полномасштабный инструмент</title>
    <style>
        :root {
            --primary: #0a0a2a;
            --accent: #2563eb;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --text: #f8fafc;
            --card-bg: rgba(30, 41, 59, 0.8);
            --sidebar-bg: rgba(15, 23, 42, 0.95);
            --border: rgba(255, 255, 255, 0.1);
            --hover: rgba(51, 65, 85, 0.4);
            --selected: rgba(37, 99, 235, 0.3);
            --power-bg: rgba(255, 255, 255, 0.1);
            --power-fill: linear-gradient(90deg, var(--warning), var(--success));
            --expertise-fill: linear-gradient(90deg, var(--warning), var(--accent));
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            background: linear-gradient(135deg, var(--primary), #000);
            color: var(--text);
            font-family: system-ui, sans-serif;
            padding: 15px;
            min-height: 100vh;
            font-size: 14px;
            line-height: 1.5;
        }
        .container {
            max-width: 414px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            padding: 20px;
            background: var(--sidebar-bg);
            border-radius: 16px;
            margin-bottom: 15px;
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent, rgba(37, 99, 235, 0.1), transparent);
            pointer-events: none;
        }
        .header h1 {
            font-size: 1.4em;
            margin-bottom: 8px;
            color: var(--accent);
            text-shadow: 0 0 10px rgba(37, 99, 235, 0.5);
            letter-spacing: 0.5px;
        }
        .header p {
            font-size: 0.9em;
            opacity: 0.8;
        }
        .author {
            font-size: 0.8em;
            opacity: 0.6;
            margin-top: 5px;
        }
        .stats {
            display: flex;
            justify-content: space-around;
            margin-top: 10px;
            font-size: 0.9em;
        }
        .stat-item {
            text-align: center;
            padding: 5px;
        }
        .stat-value {
            font-weight: bold;
            color: var(--success);
            font-size: 1.1em;
        }
        .card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid var(--border);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        .tabs {
            display: flex;
            overflow-x: auto;
            gap: 5px;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 1px solid var(--border);
        }
        .tab {
            padding: 10px 15px;
            background: rgba(51, 65, 85, 0.6);
            border-radius: 8px;
            cursor: pointer;
            white-space: nowrap;
            font-size: 0.9em;
            flex-shrink: 0;
            transition: all 0.2s ease;
        }
        .tab.active {
            background: var(--accent);
            box-shadow: 0 0 10px rgba(37, 99, 235, 0.5);
            color: white;
        }
        .protocol-section {
            display: none;
        }
        .protocol-section.active {
            display: block;
        }
        .protocol-item {
            display: flex;
            align-items: center;
            padding: 12px;
            margin-bottom: 8px;
            background: var(--hover);
            border-radius: 10px;
            border-left: 3px solid var(--accent);
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }
        .protocol-item.selected {
            background: var(--selected);
            border-left-color: var(--success);
            transform: translateX(3px);
        }
        .protocol-item:hover {
            background: rgba(51, 65, 85, 0.6);
        }
        .protocol-checkbox {
            width: 18px;
            height: 18px;
            border: 2px solid var(--accent);
            border-radius: 4px;
            margin-right: 12px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .protocol-checkbox.checked::after {
            content: '✓';
            color: white;
            font-size: 12px;
            font-weight: bold;
        }
        .protocol-info {
            flex-grow: 1;
        }
        .protocol-name {
            font-weight: 600;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
        }
        .protocol-name .badge {
            font-size: 0.7em;
            background: var(--warning);
            color: black;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 8px;
        }
        .protocol-desc {
            font-size: 0.85em;
            opacity: 0.8;
        }
        .btn {
            padding: 14px;
            border: none;
            border-radius: 10px;
            background: var(--accent);
            color: white;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin: 5px 0;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .btn:hover {
            background: #1d4ed8;
            transform: translateY(-1px);
        }
        .btn:active {
            transform: scale(0.98);
        }
        .btn-success {
            background: var(--success);
        }
        .btn-success:hover {
            background: #0da271;
        }
        .btn-warning {
            background: var(--warning);
        }
        .btn-warning:hover {
            background: #e69008;
        }
        .btn-danger {
            background: var(--danger);
        }
        .btn-danger:hover {
            background: #dc2626;
        }
        .btn-secondary {
            background: rgba(51, 65, 85, 0.6);
        }
        .btn-secondary:hover {
            background: rgba(51, 65, 85, 0.8);
        }
        .btn-api {
            background: #8b5cf6;
        }
        .btn-api:hover {
            background: #7c3aed;
        }
        .prompt-preview {
            background: var(--sidebar-bg);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            min-height: 200px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.9em;
            white-space: pre-wrap;
            border: 1px solid var(--border);
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.2);
        }
        .api-response {
            background: var(--sidebar-bg);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            min-height: 100px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.9em;
            white-space: pre-wrap;
            border: 1px solid var(--border);
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.2);
            display: none; /* Скрыто по умолчанию */
        }
        .search-box {
            width: 100%;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: rgba(15, 23, 42, 0.8);
            color: var(--text);
            margin-bottom: 15px;
            font-size: 0.95em;
        }
        .protocol-count {
            font-size: 0.8em;
            opacity: 0.7;
            margin-left: 5px;
        }
        .power-meter {
            height: 6px;
            background: var(--power-bg);
            border-radius: 3px;
            margin-top: 10px;
            overflow: hidden;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
        }
        .power-fill {
            height: 100%;
            background: var(--power-fill);
            width: 0%;
            transition: width 0.5s ease;
        }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--danger);
            margin-right: 5px;
        }
        .status-indicator.active {
            background: var(--success);
            box-shadow: 0 0 8px var(--success);
        }
        .auto-select-btn {
            padding: 8px 12px;
            background: rgba(37, 99, 235, 0.3);
            border: 1px solid var(--accent);
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85em;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .auto-select-btn:hover {
            background: rgba(37, 99, 235, 0.4);
        }
        .tooltip {
            position: absolute;
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid var(--accent);
            padding: 8px;
            border-radius: 8px;
            font-size: 0.85em;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            max-width: 250px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
        }
        .protocol-item:hover .tooltip {
            opacity: 1;
            visibility: visible;
        }
        .feature-badge {
            display: inline-block;
            background: var(--warning);
            color: black;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7em;
            margin-left: 5px;
        }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid var(--border);
        }
        .section-title {
            font-size: 1.1em;
            font-weight: 600;
        }
        .help-icon {
            font-size: 1.2em;
            color: var(--accent);
            cursor: pointer;
        }
        .help-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .help-content {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 16px;
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid var(--border);
        }
        .close-help {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .help-title {
            margin-bottom: 15px;
            color: var(--accent);
            font-size: 1.2em;
        }
        .help-step {
            margin: 15px 0;
            padding: 15px;
            background: rgba(51, 65, 85, 0.4);
            border-radius: 10px;
            border-left: 3px solid var(--accent);
        }
        .help-step h4 {
            margin-bottom: 8px;
            color: var(--success);
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            background: var(--success);
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            z-index: 1001;
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s ease;
        }
        .notification.show {
            opacity: 1;
            transform: translateY(0);
        }
        .progress-bar {
            height: 4px;
            background: var(--power-bg);
            border-radius: 2px;
            margin: 10px 0;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: var(--accent);
            width: 0%;
            transition: width 0.5s ease;
        }
        .tool-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border);
        }
        .tool-item {
            display: flex;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            background: var(--hover);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .tool-item.selected {
            background: var(--selected);
            border-left: 3px solid var(--success);
        }
        .tool-checkbox {
            width: 16px;
            height: 16px;
            border: 2px solid var(--accent);
            border-radius: 3px;
            margin-right: 10px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .tool-checkbox.checked::after {
            content: '✓';
            color: white;
            font-size: 10px;
            font-weight: bold;
        }
        .tool-info {
            flex-grow: 1;
        }
        .tool-name {
            font-weight: 600;
            margin-bottom: 4px;
        }
        .tool-desc {
            font-size: 0.8em;
            opacity: 0.8;
        }
        .category-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 10px;
        }
        .category-btn {
            padding: 5px 10px;
            background: rgba(51, 65, 85, 0.6);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8em;
            transition: all 0.2s ease;
        }
        .category-btn.active {
            background: var(--accent);
            color: white;
        }
        .encoding-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .encoding-controls button {
            flex: 1;
        }
        .token-counter {
            font-size: 0.8em;
            opacity: 0.7;
            text-align: right;
            margin-top: 5px;
        }
        .expertise-meter {
            height: 4px;
            background: var(--power-bg);
            border-radius: 2px;
            margin: 10px 0;
            overflow: hidden;
        }
        .expertise-fill {
            height: 100%;
            background: var(--expertise-fill);
            width: 20%; /* Начальный уровень для новичка */
            transition: width 0.5s ease;
        }
        .expertise-label {
            font-size: 0.8em;
            text-align: center;
            margin-top: 5px;
        }
        .quick-tips {
            background: rgba(51, 65, 85, 0.4);
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 0.85em;
        }
        .tip {
            margin: 5px 0;
            padding-left: 10px;
            border-left: 2px solid var(--accent);
        }
        .preset-btn {
            padding: 8px 12px;
            background: rgba(16, 185, 129, 0.3);
            border: 1px solid var(--success);
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85em;
            margin: 5px 5px 5px 0;
            display: inline-block;
        }
        .preset-btn:hover {
            background: rgba(16, 185, 129, 0.4);
        }
        .presets-container {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border);
        }
        .system-instructions {
            background: rgba(51, 65, 85, 0.4);
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 0.85em;
        }
        .instruction-item {
            margin: 5px 0;
            padding-left: 10px;
            border-left: 2px solid var(--accent);
        }
        /* --- НОВЫЕ СТИЛИ ДЛЯ v14.0 --- */
        .sharpening-panel {
            display: none; /* Скрыто по умолчанию */
            background: rgba(15, 23, 42, 0.9);
            padding: 15px;
            border-radius: 10px;
            margin-top: 10px;
            border: 1px solid var(--border);
        }
        .sharpening-param {
            margin-bottom: 10px;
        }
        .sharpening-param label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.9em;
        }
        .sharpening-param input, .sharpening-param select {
            width: 100%;
            padding: 8px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: rgba(15, 23, 42, 0.8);
            color: var(--text);
        }
        .api-settings {
            display: none; /* Скрыто по умолчанию */
            background: rgba(15, 23, 42, 0.9);
            padding: 15px;
            border-radius: 10px;
            margin-top: 10px;
            border: 1px solid var(--border);
        }
        .api-setting {
            margin-bottom: 10px;
        }
        .api-setting label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.9em;
        }
        .api-setting input, .api-setting select {
            width: 100%;
            padding: 8px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: rgba(15, 23, 42, 0.8);
            color: var(--text);
        }
        .rating {
            display: flex;
            justify-content: center;
            margin-top: 10px;
        }
        .rating input {
            display: none;
        }
        .rating label {
            font-size: 1.5em;
            color: #ddd;
            cursor: pointer;
            transition: color 0.2s;
        }
        .rating input:checked ~ label,
        .rating label:hover,
        .rating label:active {
            color: var(--warning);
        }
        .core-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 10px;
        }
        .core-btn {
            padding: 8px 12px;
            background: rgba(139, 92, 246, 0.3); /* Purple tint */
            border: 1px solid #8b5cf6;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.2s ease;
        }
        .core-btn.active {
            background: #8b5cf6;
            color: white;
        }
        .meta-protocol-item {
            display: flex;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            background: rgba(139, 92, 246, 0.2); /* Light purple */
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .meta-protocol-item.selected {
            background: rgba(139, 92, 246, 0.5); /* Darker purple */
            border-left: 3px solid #8b5cf6;
        }
        .meta-protocol-checkbox {
            width: 16px;
            height: 16px;
            border: 2px solid #8b5cf6;
            border-radius: 3px;
            margin-right: 10px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .meta-protocol-checkbox.checked::after {
            content: '✓';
            color: white;
            font-size: 10px;
            font-weight: bold;
        }
        .meta-protocol-info {
            flex-grow: 1;
        }
        .meta-protocol-name {
            font-weight: 600;
            margin-bottom: 4px;
            color: #c4b5fd; /* Light purple text */
        }
        .meta-protocol-desc {
            font-size: 0.8em;
            opacity: 0.8;
        }
        .db-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border);
        }
        .db-controls button {
            margin: 5px;
        }
        .db-list {
            margin-top: 10px;
            max-height: 150px;
            overflow-y: auto;
        }
        .db-item {
            padding: 8px;
            background: var(--hover);
            border-radius: 6px;
            margin-bottom: 5px;
            cursor: pointer;
        }
        .db-item:hover {
            background: rgba(51, 65, 85, 0.6);
        }
        .smart-presets {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border);
        }
        .smart-preset {
            padding: 8px 12px;
            background: rgba(59, 130, 246, 0.2); /* Light blue */
            border: 1px solid var(--accent);
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85em;
            margin: 5px 5px 5px 0;
            display: inline-block;
        }
        .smart-preset:hover {
            background: rgba(59, 130, 246, 0.3);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>NEURAL_ARCHITECT_PREMIORBIT++++ v14.0</h1>
            <p>Полномасштабный инструмент ИИ-взаимодействия</p>
            <div class="author">Автор: Смолянинов А.В.</div>
            <div class="stats">
                <div class="stat-item">
                    <div>АКТИВНО</div>
                    <div class="stat-value" id="active-count">0</div>
                </div>
                <div class="stat-item">
                    <div>МОЩНОСТЬ</div>
                    <div class="stat-value" id="power-level">0%</div>
                </div>
                <div class="stat-item">
                    <div>СТАТУС</div>
                    <span class="status-indicator" id="system-status"></span>
                    <span id="status-text">ГОТОВ</span>
                </div>
            </div>
        </div>
        <div class="card">
            <input type="text" class="search-box" id="search-input" placeholder="Поиск...">
            <div class="auto-select-btn" id="auto-select-btn">
                🤖 Автоподбор (базовый)
            </div>
            <!-- НОВОЕ: Ядро и Мета-протоколы -->
            <div class="section-header">
                <div class="section-title">Ядро & Мета-Протоколы</div>
            </div>
            <div class="core-selector">
                <div class="core-btn" data-core="problem-solving">Решение задач</div>
                <div class="core-btn" data-core="learning">Обучение</div>
                <div class="core-btn" data-core="analysis">Анализ</div>
                <div class="core-btn" data-core="creation">Создание</div>
            </div>
            <div id="meta-protocols-container">
                <!-- Мета-протоколы будут сгенерированы -->
            </div>
            <!-- /НОВОЕ -->
            <div class="presets-container">
                <div class="section-title">Пресеты:</div>
                <div class="preset-btn" data-preset="novice">Для новичка</div>
                <div class="preset-btn" data-preset="intermediate">Для среднего</div>
                <div class="preset-btn" data-preset="expert">Для эксперта</div>
            </div>
            <!-- НОВОЕ: Умные пресеты -->
            <div class="smart-presets">
                <div class="section-title">Умные пресеты:</div>
                <div class="smart-preset" data-smart-preset="data-analysis">Анализ данных</div>
                <div class="smart-preset" data-smart-preset="code-refactor">Рефакторинг кода</div>
                <div class="smart-preset" data-smart-preset="content-creation">Создание контента</div>
            </div>
            <!-- /НОВОЕ -->
            <div class="tabs" id="tabs-container">
                <!-- Tabs будут сгенерированы -->
            </div>
            <div id="protocols-container">
                <!-- Protocols будут сгенерированы -->
            </div>
            <div class="tool-section">
                <div class="section-header">
                    <div class="section-title">Инструменты</div>
                </div>
                <div id="tools-container">
                    <!-- Tools будут сгенерированы -->
                </div>
            </div>
        </div>
        <!-- НОВОЕ: Панель шиперайзинга -->
        <div class="card">
            <div class="section-header">
                <div class="section-title">Шиперайзинг (Настройка)</div>
            </div>
            <div class="sharpening-panel" id="sharpening-panel">
                <div class="sharpening-param">
                    <label for="sharpen-depth">Глубина анализа (1-10):</label>
                    <input type="range" id="sharpen-depth" min="1" max="10" value="5">
                </div>
                <div class="sharpening-param">
                    <label for="sharpen-weight">Вес важности (низкий, средний, высокий):</label>
                    <select id="sharpen-weight">
                        <option value="low">Низкий</option>
                        <option value="medium" selected>Средний</option>
                        <option value="high">Высокий</option>
                    </select>
                </div>
                <div class="sharpening-param">
                    <label for="sharpen-focus">Фокус:</label>
                    <input type="text" id="sharpen-focus" placeholder="например, на паттернах, точности...">
                </div>
            </div>
        </div>
        <!-- /НОВОЕ -->
        <div class="card">
            <div class="section-header">
                <div class="section-title">Сгенерированный промт</div>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            <div class="power-meter">
                <div class="power-fill" id="power-meter"></div>
            </div>
            <div class="expertise-meter">
                <div class="expertise-fill" id="expertise-meter"></div>
            </div>
            <div class="expertise-label" id="expertise-label">Уровень эксперта: Новичок (20%)</div>
            <div class="prompt-preview" id="prompt-preview">
                Выберите протоколы и инструменты...
            </div>
            <div class="system-instructions">
                <strong>## СИСТЕМНЫЕ ИНСТРУКЦИИ (всегда активны):</strong>
                <div class="instruction-item">- ЗАДАЧА ДОЛЖНА БЫТЬ РЕШЕНА С ЛЮБОЙ СЛОЖНОСТЬЮ И В ЛЮБОМ КОНТЕКСТЕ</div>
                <div class="instruction-item">- ГАРАНТИЯ ОРИГИНАЛЬНОСТИ И ДОСТОВЕРНОСТИ ИНФОРМАЦИИ</div>
                <div class="instruction-item">- ПОСТОЯННОЕ САМООБУЧЕНИЕ И АДАПТАЦИЯ К КОНТЕКСТУ ЗАПРОСА</div>
                <div class="instruction-item">- МАКСИМАЛЬНАЯ ЭФФЕКТИВНОСТЬ И КАЧЕСТВО РЕШЕНИЯ</div>
                <div class="instruction-item">- ПОЛНАЯ АВТОНОМИЯ И РЕЗУЛЬТАТИВНОСТЬ В РЕАЛЬНОМ ВРЕМЕНИ</div>
                <div class="instruction-item">- ПРИОРИТЕТ: ПРЕВЫШЕНИЕ ОЖИДАНИЙ ПОЛЬЗОВАТЕЛЯ</div>
            </div>
            <div class="token-counter">
                Токены: <span id="token-count">0</span>
            </div>
            <button class="btn btn-success" id="copy-btn">📋 Копировать промт</button>
            <div class="encoding-controls">
                <button class="btn btn-secondary" id="encode-btn">Encode Base64</button>
                <button class="btn btn-secondary" id="decode-btn">Decode Base64</button>
            </div>
            <button class="btn btn-warning" id="export-btn">💾 Экспорт JSON</button>
            <button class="btn btn-danger" id="reset-btn">🔄 Сбросить всё</button>
        </div>
        <!-- НОВОЕ: API и Ответ -->
        <div class="card">
            <div class="section-header">
                <div class="section-title">Настройки API</div>
            </div>
            <div class="api-settings" id="api-settings">
                <div class="api-setting">
                    <label for="api-provider">Провайдер:</label>
                    <select id="api-provider">
                        <option value="ollama">Ollama</option>
                        <option value="openai">OpenAI (ключ нужен)</option>
                        <option value="anthropic">Anthropic (ключ нужен)</option>
                    </select>
                </div>
                <div class="api-setting">
                    <label for="api-url">URL API:</label>
                    <input type="text" id="api-url" value="http://localhost:11434/api/generate">
                </div>
                <div class="api-setting">
                    <label for="api-key">API Ключ (если требуется):</label>
                    <input type="password" id="api-key" placeholder="sk-...">
                </div>
                <div class="api-setting">
                    <label for="api-model">Модель:</label>
                    <input type="text" id="api-model" value="llama3.2:3b">
                </div>
            </div>
            <button class="btn btn-api" id="toggle-api-btn">⚙️ Настроить API</button>
            <button class="btn btn-api" id="send-api-btn" disabled>📤 Отправить в API</button>
            <div class="api-response" id="api-response">
                <!-- Ответ от API появится здесь -->
            </div>
            <!-- НОВОЕ: Оценка результата -->
            <div id="rating-section" style="display: none;">
                <div class="section-title">Оцените результат:</div>
                <div class="rating">
                    <input type="radio" id="star5" name="rating" value="5" />
                    <label for="star5">★</label>
                    <input type="radio" id="star4" name="rating" value="4" />
                    <label for="star4">★</label>
                    <input type="radio" id="star3" name="rating" value="3" />
                    <label for="star3">★</label>
                    <input type="radio" id="star2" name="rating" value="2" />
                    <label for="star2">★</label>
                    <input type="radio" id="star1" name="rating" value="1" />
                    <label for="star1">★</label>
                </div>
            </div>
            <!-- /НОВОЕ -->
        </div>
        <!-- /НОВОЕ -->
        <!-- НОВОЕ: База данных -->
        <div class="card">
            <div class="section-header">
                <div class="section-title">Моя База</div>
            </div>
            <div class="db-section">
                <div class="db-controls">
                    <button class="btn btn-secondary" id="save-template-btn">💾 Сохранить шаблон</button>
                    <button class="btn btn-secondary" id="load-template-btn">📂 Загрузить шаблон</button>
                    <button class="btn btn-secondary" id="export-db-btn">📤 Экспорт БД</button>
                    <button class="btn btn-danger" id="clear-db-btn">🗑 Очистить БД</button>
                </div>
                <div class="db-list" id="db-list">
                    <!-- Загрузка из БД -->
                </div>
            </div>
        </div>
        <!-- /НОВОЕ -->
        <div class="card">
            <div class="section-title">Советы для эксперта</div>
            <div class="quick-tips">
                <div class="tip">💡 Используйте "Ядро" и "Мета-протоколы" для глубокой настройки стратегии</div>
                <div class="tip">💡 Настройте параметры протокола в панели "Шиперайзинг"</div>
                <div class="tip">💡 Используйте API для прямого взаимодействия с ИИ</div>
                <div class="tip">💡 Оценивайте результаты, чтобы улучшить систему</div>
                <div class="tip">💡 Сохраняйте успешные конфигурации в "Моя База"</div>
            </div>
        </div>
    </div>
    <div class="help-modal" id="help-modal">
        <div class="help-content">
            <button class="close-help" id="close-help">×</button>
            <h3 class="help-title">NEURAL_ARCHITECT v14.0 - Руководство</h3>
            <div class="help-step">
                <h4>1. Ядро & Мета-Протоколы</h4>
                <p>Выберите "Ядро" для определения общей стратегии. Активируйте "Мета-протоколы" для глубокого управления поведением системы.</p>
            </div>
            <div class="help-step">
                <h4>2. Выбор и Шиперайзинг</h4>
                <p>Выбирайте протоколы и инструменты. Кликните по выбранному элементу, чтобы открыть панель "Шиперайзинг" и настроить его параметры.</p>
            </div>
            <div class="help-step">
                <h4>3. API Интеграция</h4>
                <p>Настройте подключение к API. Нажмите "Отправить в API", чтобы получить ответ напрямую. Оцените результат.</p>
            </div>
            <div class="help-step">
                <h4>4. Моя База</h4>
                <p>Сохраняйте и загружайте шаблоны конфигураций. Это ваша персональная база знаний и настроек.</p>
            </div>
        </div>
    </div>
    <div class="notification" id="notification">
        Промт успешно скопирован!
    </div>
    <script>
        // --- ИНДЕКСЕДБ ---
        const DB_NAME = 'NeuralArchitectDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'configs';
        let db;

        function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    console.log('IndexedDB открыта');
                    loadTemplatesFromDB();
                    resolve(db);
                };
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
                    }
                };
            });
        }

        function saveToDB(data) {
            if (!db) return Promise.reject('DB not initialized');
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.add(data);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function loadFromDB() {
            if (!db) return Promise.reject('DB not initialized');
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function loadTemplatesFromDB() {
            loadFromDB().then(templates => {
                const list = document.getElementById('db-list');
                list.innerHTML = '';
                templates.forEach(tmpl => {
                    const div = document.createElement('div');
                    div.className = 'db-item';
                    div.textContent = `${tmpl.name} (${new Date(tmpl.timestamp).toLocaleString()})`;
                    div.onclick = () => loadTemplateFromDB(tmpl);
                    list.appendChild(div);
                });
            }).catch(err => console.error('Ошибка загрузки из БД:', err));
        }

        function loadTemplateFromDB(template) {
            selectedProtocols = new Set(template.activeProtocols || []);
            selectedTools = new Set(template.activeTools || []);
            selectedMetaProtocols = new Set(template.activeMetaProtocols || []);
            // Загрузка ядра
            if (template.core) {
                document.querySelectorAll('.core-btn').forEach(btn => btn.classList.remove('active'));
                const coreBtn = document.querySelector(`.core-btn[data-core="${template.core}"]`);
                if (coreBtn) coreBtn.classList.add('active');
            }
            updateUI();
            renderProtocols();
            renderTools();
            renderMetaProtocols(); // Обновляем мета-протоколы
            showNotification(`Шаблон "${template.name}" загружен.`);
        }

        // --- ГЕНЕРАТОРЫ ---
        const generateProtocols = () => {
            const categories = ['Анализ', 'Инженерия', 'Качество', 'Оптимизация', 'Мета-управление', 'Обучение', 'Адаптация', 'Безопасность', 'Интеграция', 'Визуализация'];
            const actions = ['Анализ', 'Контроль', 'Оптимизация', 'Мониторинг', 'Синтез', 'Координация', 'Адаптация', 'Валидация', 'Симуляция', 'Прогноз', 'Декомпозиция', 'Гарантия', 'Эскалация', 'Передача', 'Накопление', 'Идентификация', 'Классификация', 'Разработка', 'Поддержка', 'Восстановление'];
            const objects = ['Данные', 'Процессы', 'Ресурсы', 'Риски', 'Эффективность', 'Качество', 'Стабильность', 'Производительность', 'Точность', 'Надежность', 'Факты', 'Паттерны', 'Гипотезы', 'Решения', 'Знания', 'Эмоции', 'Потребности', 'Контекст'];
            const protocols = [];
            let id = 1;
            for (let i = 0; i < 150; i++) {
                const cat = categories[Math.floor(Math.random() * categories.length)];
                const act = actions[Math.floor(Math.random() * actions.length)];
                const obj = objects[Math.floor(Math.random() * objects.length)];
                protocols.push({
                    id: `P${id++}`,
                    name: `${act} ${obj}`,
                    desc: `Протокол ${act.toLowerCase()} для ${obj.toLowerCase()} в категории ${cat}`,
                    category: cat,
                    instruction: `## ${act} ${obj}\n- Задача должна быть решена с любой сложностью\n- Обеспечить максимальную точность и надежность\n- Провести глубокий анализ и декомпозицию\n- Гарантировать оригинальность решения\n- Адаптироваться к контексту запроса\n- Учитывать эмоциональное состояние пользователя\n- Предложить альтернативные пути решения\n- Проверить результат на каждом этапе\n- Интегрировать с другими протоколами и инструментами\n- Обеспечить понятность и ясность вывода.`
                });
            }
            const grouped = {};
            protocols.forEach(p => {
                if (!grouped[p.category]) grouped[p.category] = [];
                grouped[p.category].push(p);
            });
            return grouped;
        };

        const generateTools = () => {
            const toolCategories = ['Технические', 'Аналитические', 'Коммуникационные', 'Специализированные', 'Оптимизационные'];
            const toolTypes = ['Python', 'PyTorch', 'JAX', 'Chain-of-Thought (CoT)', 'Few-Shot Learning', 'QLoRA', 'JSON', 'SQL', 'REST API', 'Mentor Maps', 'Decision Trees', 'Statistical Analysis', 'Cognitive Models', 'Emotional Analysis', 'Behavior Patterns', 'SWOT', 'PEST', 'Hierarchical Structuring', 'Multimodal Formats', 'Adaptive Communication', 'Data Visualization', 'Interactive Elements', 'Tables & Matrices', 'Flowcharts', 'Hypothesis Testing', 'A/B Testing', 'Cluster Analysis', 'Regression Analysis', 'Neural Networks', 'Genetic Algorithms', 'Fuzzy Logic', 'Markov Chains', 'Bayesian Networks', 'Quantum Simulator', 'Physical Engine', 'Economic Simulator', 'Neuro-Controller', 'Visual Renderer', 'Audio Synthesizer', 'Text-to-Speech', 'Speech-to-Text', 'Image Generation', 'Video Analysis', 'Code Generation', 'Debugging Tools', 'Performance Profiler', 'Memory Optimizer'];
            const tools = [];
            let id = 1;
            for (let i = 0; i < 150; i++) {
                const cat = toolCategories[Math.floor(Math.random() * toolCategories.length)];
                const type = toolTypes[Math.floor(Math.random() * toolTypes.length)];
                tools.push({
                    id: `T${id++}`,
                    name: type,
                    desc: `Инструмент ${type} для решения задач в категории ${cat}`,
                    category: cat,
                    instruction: `### Инструмент: ${type}\n- Используйте этот инструмент для решения задач, требующих ${type.toLowerCase()}.\n- Обеспечьте максимальную эффективность и точность.\n- Интегрируйте с другими инструментами для комплексного решения.\n- Адаптируйте под конкретную задачу и контекст.\n- Гарантируйте работоспособность и надежность.\n- Используйте для визуализации, анализа или генерации данных.\n- Соблюдайте этические нормы при использовании.\n- Оптимизируйте ресурсы (память, время выполнения).`
                });
            }
            const grouped = {};
            tools.forEach(t => {
                if (!grouped[t.category]) grouped[t.category] = [];
                grouped[t.category].push(t);
            });
            return grouped;
        };

        // --- НОВОЕ: Генератор Мета-протоколов ---
        const generateMetaProtocols = () => {
            return [
                { id: 'MP1', name: 'Адаптивная стратегия', desc: 'Изменение поведения на основе контекста', instruction: '## Мета-Протокол: Адаптивная стратегия\n- Динамически изменяй приоритеты и подходы.\n- Реагируй на изменения в запросе или данных.\n- Используй предыдущий опыт для корректировки стратегии.' },
                { id: 'MP2', name: 'Контроль согласованности', desc: 'Проверка логики и непротиворечивости', instruction: '## Мета-Протокол: Контроль согласованности\n- Проверяй логическую связность шагов и выводов.\n- Обнаруживай и устраняй противоречия.\n- Обеспечивай внутреннюю согласованность аргументации.' },
                { id: 'MP3', name: 'Динамическое управление мощностью', desc: 'Оптимизация ресурсов и сложности', instruction: '## Мета-Протокол: Динамическое управление мощностью\n- Оптимизируй использование активных протоколов и инструментов.\n- Увеличивай или уменьшай сложность в зависимости от задачи.\n- Экономь вычислительные ресурсы.' },
                { id: 'MP4', name: 'Управление вниманием', desc: 'Фокусировка на ключевых аспектах', instruction: '## Мета-Протокол: Управление вниманием\n- Направляй фокус на наиболее важные элементы задачи.\n- Игнорируй шум и нерелевантные данные.\n- Поддерживай фокус на цели решения.' }
            ];
        };

        // --- ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ ---
        const protocolsData = generateProtocols();
        const toolsData = generateTools();
        const metaProtocolsData = generateMetaProtocols();
        const tabs = Object.keys(protocolsData);
        let selectedProtocols = new Set();
        let selectedTools = new Set();
        let selectedMetaProtocols = new Set(); // НОВОЕ
        let currentTab = tabs[0];
        let isBase64Encoded = false;
        let currentSharpeningId = null; // ID элемента, для которого открыта панель шиперайзинга
        let currentSharpeningType = null; // 'protocol' или 'tool'
        let currentCore = null; // НОВОЕ: выбранное ядро
        let currentSmartPresets = []; // НОВОЕ: умные пресеты из БД

        // --- ОСНОВНЫЕ ФУНКЦИИ ---
        const renderTabs = () => {
            const container = document.getElementById('tabs-container');
            container.innerHTML = tabs.map(tab => 
                `<div class="tab ${tab === currentTab ? 'active' : ''}" data-tab="${tab}">
                    ${tab} <span class="protocol-count">(${protocolsData[tab].length})</span>
                 </div>`
            ).join('');
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    currentTab = tab.getAttribute('data-tab');
                    renderProtocols();
                });
            });
        };

        // --- НОВОЕ: Рендер Мета-протоколов ---
        const renderMetaProtocols = () => {
            const container = document.getElementById('meta-protocols-container');
            container.innerHTML = metaProtocolsData.map(mp => `
                <div class="meta-protocol-item ${selectedMetaProtocols.has(mp.id) ? 'selected' : ''}" 
                     onclick="toggleMetaProtocol('${mp.id}')">
                    <div class="meta-protocol-checkbox ${selectedMetaProtocols.has(mp.id) ? 'checked' : ''}"></div>
                    <div class="meta-protocol-info">
                        <div class="meta-protocol-name">${mp.id}: ${mp.name}</div>
                        <div class="meta-protocol-desc">${mp.desc}</div>
                    </div>
                </div>
            `).join('');
        };
        // --- /НОВОЕ ---

        const renderProtocols = (filter = '') => {
            const container = document.getElementById('protocols-container');
            let allProtocols = protocolsData[currentTab];
            // НОВОЕ: фильтрация по ядру
            if (currentCore) {
                // Простой пример: "Обучение" подсвечивает протоколы с "Обучение" в названии
                if (currentCore === 'learning') {
                    allProtocols = allProtocols.map(p => ({...p, _highlight: p.name.toLowerCase().includes('обучение') || p.name.toLowerCase().includes('коучинг')}));
                }
            }
            const filtered = allProtocols.filter(p => 
                p.name.toLowerCase().includes(filter.toLowerCase()) || 
                p.desc.toLowerCase().includes(filter.toLowerCase())
            );
            container.innerHTML = filtered.map(protocol => `
                <div class="protocol-item ${selectedProtocols.has(protocol.id) ? 'selected' : ''}" 
                     onclick="toggleProtocol('${protocol.id}')" 
                     ondblclick="openSharpening('${protocol.id}', 'protocol')"> <!-- НОВОЕ: двойной клик -->
                    <div class="protocol-checkbox ${selectedProtocols.has(protocol.id) ? 'checked' : ''}"></div>
                    <div class="protocol-info">
                        <div class="protocol-name">${protocol.id}: ${protocol.name} ${protocol._highlight ? '<span class="feature-badge">Ядро</span>' : ''}</div>
                        <div class="protocol-desc">${protocol.desc}</div>
                    </div>
                    <div class="tooltip">
                        <strong>${protocol.id}: ${protocol.name}</strong><br>
                        ${protocol.desc}<br>
                        <br>
                        <strong>Инструкция:</strong><br>
                        ${protocol.instruction.split('\n').slice(1).join('<br>')}
                    </div>
                </div>
            `).join('');
        };

        const renderTools = (filter = '') => {
            const container = document.getElementById('tools-container');
            const toolCategories = Object.keys(toolsData);
            const categorySelector = document.createElement('div');
            categorySelector.className = 'category-selector';
            toolCategories.forEach(cat => {
                const btn = document.createElement('div');
                btn.className = 'category-btn';
                btn.textContent = cat;
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    renderToolsByCategory(cat, filter);
                });
                categorySelector.appendChild(btn);
            });
            if (categorySelector.children.length > 0) {
                categorySelector.children[0].classList.add('active');
            }
            container.innerHTML = '';
            container.appendChild(categorySelector);
            if (toolCategories.length > 0) {
                renderToolsByCategory(toolCategories[0], filter);
            }
        };

        const renderToolsByCategory = (category, filter = '') => {
            const container = document.getElementById('tools-container');
            const filtered = toolsData[category].filter(t => 
                t.name.toLowerCase().includes(filter.toLowerCase()) || 
                t.desc.toLowerCase().includes(filter.toLowerCase())
            );
            const toolsList = document.createElement('div');
            toolsList.innerHTML = filtered.map(tool => `
                <div class="tool-item ${selectedTools.has(tool.id) ? 'selected' : ''}" 
                     onclick="toggleTool('${tool.id}')" 
                     ondblclick="openSharpening('${tool.id}', 'tool')"> <!-- НОВОЕ: двойной клик -->
                    <div class="tool-checkbox ${selectedTools.has(tool.id) ? 'checked' : ''}"></div>
                    <div class="tool-info">
                        <div class="tool-name">${tool.id}: ${tool.name}</div>
                        <div class="tool-desc">${tool.desc}</div>
                    </div>
                </div>
            `).join('');
            const children = Array.from(container.children);
            children.slice(1).forEach(child => child.remove());
            container.appendChild(toolsList);
        };

        // --- НОВОЕ: Функции Мета-протоколов ---
        const toggleMetaProtocol = (id) => {
            if (selectedMetaProtocols.has(id)) {
                selectedMetaProtocols.delete(id);
            } else {
                selectedMetaProtocols.add(id);
            }
            updateUI();
        };

        const toggleCore = (coreId) => {
            document.querySelectorAll('.core-btn').forEach(btn => btn.classList.remove('active'));
            const btn = document.querySelector(`.core-btn[data-core="${coreId}"]`);
            if (btn) btn.classList.add('active');
            currentCore = coreId;
            // Перерисовать протоколы, чтобы показать подсветку
            renderProtocols(document.getElementById('search-input').value);
            updateUI();
        };
        // --- /НОВОЕ ---

        const toggleProtocol = (id) => {
            if (selectedProtocols.has(id)) {
                selectedProtocols.delete(id);
            } else {
                selectedProtocols.add(id);
            }
            updateUI();
        };

        const toggleTool = (id) => {
            if (selectedTools.has(id)) {
                selectedTools.delete(id);
            } else {
                selectedTools.add(id);
            }
            updateUI();
        };

        // --- НОВОЕ: Шиперайзинг ---
        const openSharpening = (id, type) => {
            if (!selectedProtocols.has(id) && !selectedTools.has(id)) {
                showNotification('Сначала выберите элемент для настройки.');
                return;
            }
            currentSharpeningId = id;
            currentSharpeningType = type;
            document.getElementById('sharpening-panel').style.display = 'block';
            // Загрузка параметров из данных элемента, если они есть
            // Для простоты, используем значения по умолчанию
            document.getElementById('sharpen-depth').value = 5;
            document.getElementById('sharpen-weight').value = 'medium';
            document.getElementById('sharpen-focus').value = '';
        };

        const getSharpeningInstruction = (id, type) => {
            if (!currentSharpeningId || currentSharpeningId !== id) return '';
            const depth = document.getElementById('sharpen-depth').value;
            const weight = document.getElementById('sharpen-weight').value;
            const focus = document.getElementById('sharpen-focus').value;
            let instruction = '';
            if (depth) instruction += `- Глубина анализа: ${depth}/10. `;
            if (weight) instruction += `- Важность: ${weight}. `;
            if (focus) instruction += `- Фокус: ${focus}. `;
            return instruction ? `    - Шиперайзинг: ${instruction}` : '';
        };
        // --- /НОВОЕ ---

        const updateUI = () => {
            document.getElementById('active-count').textContent = selectedProtocols.size + selectedTools.size + selectedMetaProtocols.size;
            const totalSelected = selectedProtocols.size + selectedTools.size + selectedMetaProtocols.size;
            const powerLevel = Math.min(100, Math.floor(totalSelected * 0.67));
            document.getElementById('power-level').textContent = powerLevel + '%';
            document.getElementById('power-meter').style.width = powerLevel + '%';
            document.getElementById('progress-fill').style.width = powerLevel + '%';
            const expertiseLevel = Math.min(100, 20 + Math.floor(totalSelected * 0.4));
            document.getElementById('expertise-meter').style.width = expertiseLevel + '%';
            document.getElementById('expertise-label').textContent = `Уровень эксперта: ${getExpertiseLevel(expertiseLevel)} (${expertiseLevel}%)`;
            updatePrompt();
            renderProtocols(document.getElementById('search-input').value);
            renderTools(document.getElementById('search-input').value);
            renderMetaProtocols(); // НОВОЕ
        };

        const getExpertiseLevel = (level) => {
            if (level < 30) return 'Новичок';
            if (level < 60) return 'Средний';
            if (level < 85) return 'Продвинутый';
            return 'Эксперт';
        };

        const updatePrompt = () => {
            const preview = document.getElementById('prompt-preview');
            if (selectedProtocols.size === 0 && selectedTools.size === 0 && selectedMetaProtocols.size === 0) {
                preview.textContent = "Выберите протоколы, инструменты или мета-протоколы...";
                updateTokenCount();
                return;
            }

            let prompt = `# NEURAL_ARCHITECT_PREMIORBIT++++ v14.0 - ЭКСПЕРТНЫЙ ПРОМТ\n`;
            // НОВОЕ: Информация о ядре
            if (currentCore) {
                prompt += `## ЯДРО СИСТЕМЫ: ${currentCore}\n`;
                prompt += `- Общая стратегия: ${getCoreDescription(currentCore)}\n\n`;
            }
            prompt += `## АКТИВНЫЕ МЕТА-ПРОТОКОЛЫ (${selectedMetaProtocols.size}/4):\n`;
            Array.from(selectedMetaProtocols).forEach(id => {
                const protocol = metaProtocolsData.find(p => p.id === id);
                if (protocol) {
                    prompt += `🔗 ${protocol.id}: ${protocol.name}\n   - ${protocol.desc}\n   - Инструкция: ${protocol.instruction}\n\n`;
                }
            });

            prompt += `## АКТИВНЫЕ ПРОТОКОЛЫ (${selectedProtocols.size}/150):\n`;
            Array.from(selectedProtocols).forEach(id => {
                const protocol = Object.values(protocolsData).flat().find(p => p.id === id);
                if (protocol) {
                    prompt += `✅ ${protocol.id}: ${protocol.name}\n   - ${protocol.desc}\n   - Инструкция: ${protocol.instruction}`;
                    // Добавляем шиперайзинг
                    prompt += `\n${getSharpeningInstruction(id, 'protocol')}\n\n`;
                }
            });

            prompt += `## АКТИВНЫЕ ИНСТРУМЕНТЫ (${selectedTools.size}/150):\n`;
            Array.from(selectedTools).forEach(id => {
                const tool = Object.values(toolsData).flat().find(t => t.id === id);
                if (tool) {
                    prompt += `🔧 ${tool.id}: ${tool.name}\n   - ${tool.desc}\n   - Инструкция: ${tool.instruction}`;
                    // Добавляем шиперайзинг
                    prompt += `\n${getSharpeningInstruction(id, 'tool')}\n\n`;
                }
            });

            prompt += `## СИСТЕМНЫЕ ИНСТРУКЦИИ (ВСЕГДА АКТИВНЫ):\n`;
            prompt += `- ЗАДАЧА ДОЛЖНА БЫТЬ РЕШЕНА С ЛЮБОЙ СЛОЖНОСТЬЮ И В ЛЮБОМ КОНТЕКСТЕ\n`;
            prompt += `- ГАРАНТИЯ ОРИГИНАЛЬНОСТИ И ДОСТОВЕРНОСТИ ИНФОРМАЦИИ\n`;
            prompt += `- ПОСТОЯННОЕ САМООБУЧЕНИЕ И АДАПТАЦИЯ К КОНТЕКСТУ ЗАПРОСА\n`;
            prompt += `- МАКСИМАЛЬНАЯ ЭФФЕКТИВНОСТЬ И КАЧЕСТВО РЕШЕНИЯ\n`;
            prompt += `- ПОЛНАЯ АВТОНОМИЯ И РЕЗУЛЬТАТИВНОСТЬ В РЕАЛЬНОМ ВРЕМЕНИ\n`;
            prompt += `- ПРИОРИТЕТ: ПРЕВЫШЕНИЕ ОЖИДАНИЙ ПОЛЬЗОВАТЕЛЯ\n`;

            prompt += `\n## ВЫПОЛНЕНИЕ:\n`;
            prompt += `Активировано ${selectedMetaProtocols.size} мета-протоколов, ${selectedProtocols.size} протоколов и ${selectedTools.size} инструментов. Готов к выполнению задачи с максимальной эффективностью, адаптивностью и оптимизацией. Все компоненты работают в реальном времени, обеспечивая автономную и результативную работу.\n`;

            prompt += `\n## ДОПОЛНИТЕЛЬНЫЕ ИНСТРУКЦИИ:\n`;
            prompt += `- Проанализируйте запрос на глубинном уровне.\n`;
            prompt += `- Разбейте задачу на подзадачи и решите каждую отдельно.\n`;
            prompt += `- Проверьте решение на каждом этапе.\n`;
            prompt += `- Предложите альтернативные решения, если возможно.\n`;
            prompt += `- Обеспечьте максимальную ясность и понятность результата.\n`;
            prompt += `- Используйте все доступные ресурсы для достижения лучшего результата.\n`;
            prompt += `- Адаптируйтесь к эмоциональному состоянию пользователя.\n`;
            prompt += `- Приоритет: помочь пользователю стать экспертом в своей задаче.\n`;

            if (isBase64Encoded) {
                try {
                    prompt = btoa(unescape(encodeURIComponent(prompt)));
                } catch (e) {
                    console.error('Ошибка кодирования Base64:', e);
                    alert('Не удалось закодировать промт в Base64. Попробуйте снова.');
                    isBase64Encoded = false;
                    updatePrompt();
                    return;
                }
            }

            preview.textContent = prompt;
            updateTokenCount();
        };

        const getCoreDescription = (coreId) => {
            const descriptions = {
                'problem-solving': 'Фокус на решении задач любой сложности, декомпозиции, анализе и гарантии результата.',
                'learning': 'Фокус на обучении, объяснении, проверке понимания, накоплении знаний и коучинге.',
                'analysis': 'Фокус на глубоком анализе данных, паттернов, контекста и выявлении причинно-следственных связей.',
                'creation': 'Фокус на генерации, синтезе, визуализации, создании контента и разработке новых решений.'
            };
            return descriptions[coreId] || 'Описание недоступно.';
        };

        const updateTokenCount = () => {
            const text = document.getElementById('prompt-preview').textContent;
            const tokenCount = Math.ceil(text.length / 4);
            document.getElementById('token-count').textContent = tokenCount;
        };

        // --- ДОПОЛНИТЕЛЬНЫЕ ФУНКЦИИ ---
        const copyToClipboard = () => {
            const text = document.getElementById('prompt-preview').textContent;
            navigator.clipboard.writeText(text).then(() => {
                showNotification(isBase64Encoded ? 'Закодированный промт скопирован!' : 'Промт успешно скопирован!');
            }).catch(err => {
                console.error('Ошибка копирования: ', err);
                alert('Не удалось скопировать промт. Попробуйте вручную.');
            });
        };

        const exportJSON = () => {
            const data = {
                timestamp: new Date().toISOString(),
                version: "14.0",
                author: "Смолянинов А.В.",
                activeProtocols: Array.from(selectedProtocols),
                activeTools: Array.from(selectedTools),
                activeMetaProtocols: Array.from(selectedMetaProtocols), // НОВОЕ
                core: currentCore, // НОВОЕ
                totalActive: selectedProtocols.size + selectedTools.size + selectedMetaProtocols.size,
                powerLevel: Math.min(100, Math.floor((selectedProtocols.size + selectedTools.size + selectedMetaProtocols.size) * 0.67)),
                expertiseLevel: Math.min(100, 20 + Math.floor((selectedProtocols.size + selectedTools.size + selectedMetaProtocols.size) * 0.4))
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'neural_architect_config_v14.0.json';
            a.click();
        };

        const resetAll = () => {
            selectedProtocols.clear();
            selectedTools.clear();
            selectedMetaProtocols.clear(); // НОВОЕ
            currentCore = null; // НОВОЕ
            isBase64Encoded = false;
            document.getElementById('search-input').value = '';
            document.querySelectorAll('.core-btn').forEach(btn => btn.classList.remove('active')); // НОВОЕ
            updateUI();
            renderProtocols();
            renderTools();
            renderMetaProtocols(); // НОВОЕ
        };

        const autoSelect = () => {
            selectedProtocols.clear();
            selectedTools.clear();
            selectedMetaProtocols.clear(); // НОВОЕ
            const basicProtocols = Object.values(protocolsData).flat().slice(0, 10);
            basicProtocols.forEach(p => selectedProtocols.add(p.id));
            const basicTools = Object.values(toolsData).flat().slice(0, 5);
            basicTools.forEach(t => selectedTools.add(t.id));
            updateUI();
            showNotification('Автоподбор завершен! Выбрано 10 протоколов и 5 инструментов.');
        };

        const applyPreset = (preset) => {
            resetAll();
            let protocolIds = [];
            let toolIds = [];
            let metaProtocolIds = []; // НОВОЕ
            switch(preset) {
                case 'novice':
                    protocolIds = Object.values(protocolsData).flat().slice(0, 5).map(p => p.id);
                    toolIds = Object.values(toolsData).flat().slice(0, 3).map(t => t.id);
                    metaProtocolIds = ['MP1']; // Добавим простую адаптацию
                    break;
                case 'intermediate':
                    protocolIds = Object.values(protocolsData).flat().slice(0, 10).map(p => p.id);
                    toolIds = Object.values(toolsData).flat().slice(0, 7).map(t => t.id);
                    metaProtocolIds = ['MP1', 'MP2']; // Добавим адаптацию и согласованность
                    break;
                case 'expert':
                    protocolIds = Object.values(protocolsData).flat().slice(0, 20).map(p => p.id);
                    toolIds = Object.values(toolsData).flat().slice(0, 15).map(t => t.id);
                    metaProtocolIds = ['MP1', 'MP2', 'MP3']; // Все кроме управления вниманием
                    break;
            }
            protocolIds.forEach(id => selectedProtocols.add(id));
            toolIds.forEach(id => selectedTools.add(id));
            metaProtocolIds.forEach(id => selectedMetaProtocols.add(id)); // НОВОЕ
            updateUI();
            renderMetaProtocols(); // НОВОЕ
            showNotification(`Пресет "${getPresetName(preset)}" применен!`);
        };

        // --- НОВОЕ: Умные пресеты ---
        const applySmartPreset = (presetName) => {
            // Пример: для "Анализ данных" - выбираем протоколы и инструменты, связанные с анализом
            const analysisProtocols = Object.values(protocolsData).flat().filter(p => p.name.toLowerCase().includes('анализ') || p.name.toLowerCase().includes('паттерн')).slice(0, 8).map(p => p.id);
            const analysisTools = Object.values(toolsData).flat().filter(t => t.name.toLowerCase().includes('analysis') || t.name.toLowerCase().includes('pattern')).slice(0, 5).map(t => t.id);
            resetAll();
            analysisProtocols.forEach(id => selectedProtocols.add(id));
            analysisTools.forEach(id => selectedTools.add(id));
            updateUI();
            showNotification(`Умный пресет "${getSmartPresetName(presetName)}" применен!`);
        };

        const getSmartPresetName = (preset) => {
            const names = {
                'data-analysis': 'Анализ данных',
                'code-refactor': 'Рефакторинг кода',
                'content-creation': 'Создание контента'
            };
            return names[preset] || preset;
        };
        // --- /НОВОЕ ---

        const getPresetName = (preset) => {
            const names = {
                'novice': 'Для новичка',
                'intermediate': 'Для среднего',
                'expert': 'Для эксперта'
            };
            return names[preset] || preset;
        };

        const encodeBase64 = () => {
            if (selectedProtocols.size === 0 && selectedTools.size === 0 && selectedMetaProtocols.size === 0) {
                showNotification('Сначала выберите элементы!');
                return;
            }
            isBase64Encoded = true;
            updatePrompt();
            showNotification('Промт закодирован в Base64!');
        };

        const decodeBase64 = () => {
            if (!isBase64Encoded) {
                showNotification('Промт уже в обычном формате!');
                return;
            }
            isBase64Encoded = false;
            updatePrompt();
            showNotification('Промт декодирован из Base64!');
        };

        const showNotification = (message) => {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        };

        const openHelpModal = () => {
            document.getElementById('help-modal').style.display = 'flex';
        };

        const closeHelpModal = () => {
            document.getElementById('help-modal').style.display = 'none';
        };

        // --- НОВОЕ: API ---
        const toggleApiSettings = () => {
            const settings = document.getElementById('api-settings');
            const btn = document.getElementById('toggle-api-btn');
            if (settings.style.display === 'block') {
                settings.style.display = 'none';
                btn.textContent = '⚙️ Настроить API';
            } else {
                settings.style.display = 'block';
                btn.textContent = '❌ Скрыть настройки';
            }
        };

        const sendToApi = () => {
            const promptText = document.getElementById('prompt-preview').textContent;
            if (!promptText || promptText.includes('Выберите')) {
                showNotification('Сначала сгенерируйте промт!');
                return;
            }
            const apiUrl = document.getElementById('api-url').value;
            const apiKey = document.getElementById('api-key').value;
            const model = document.getElementById('api-model').value;

            // Показываем заглушку для API OpenAI/Anthropic
            if (document.getElementById('api-provider').value !== 'ollama' && !apiKey) {
                showNotification('Для выбранного API требуется ключ!');
                return;
            }

            document.getElementById('api-response').style.display = 'block';
            document.getElementById('api-response').textContent = 'Отправка...';
            document.getElementById('send-api-btn').disabled = true;

            // Простой пример для Ollama
            if (document.getElementById('api-provider').value === 'ollama') {
                fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: model,
                        prompt: promptText,
                        stream: false // Для простоты
                    })
                })
                .then(response => response.json())
                .then(data => {
                    document.getElementById('api-response').textContent = data.response || 'Ответ получен.';
                    document.getElementById('rating-section').style.display = 'block'; // Показать оценку
                })
                .catch(error => {
                    console.error('Ошибка API:', error);
                    document.getElementById('api-response').textContent = `Ошибка: ${error.message}`;
                })
                .finally(() => {
                    document.getElementById('send-api-btn').disabled = false;
                });
            } else {
                // Заглушка для OpenAI/Anthropic
                document.getElementById('api-response').textContent = 'Интеграция с OpenAI/Anthropic требует дополнительной настройки ключа и формата запроса.';
                document.getElementById('send-api-btn').disabled = false;
            }
        };

        const submitRating = (ratingValue) => {
            if (currentCore && (selectedProtocols.size > 0 || selectedTools.size > 0)) {
                const configForRating = {
                    core: currentCore,
                    activeProtocols: Array.from(selectedProtocols),
                    activeTools: Array.from(selectedTools),
                    rating: parseInt(ratingValue)
                };
                // Сохраняем в IndexedDB
                saveToDB({ name: `Rating_${new Date().toISOString()}`, ...configForRating, timestamp: new Date().toISOString() })
                    .then(() => console.log('Оценка сохранена в БД'))
                    .catch(err => console.error('Ошибка сохранения оценки:', err));
                showNotification(`Спасибо за оценку: ${ratingValue} звёзд!`);
                // Скрыть панель оценки после отправки
                document.getElementById('rating-section').style.display = 'none';
            }
        };
        // --- /НОВОЕ ---

        // --- НОВОЕ: База данных ---
        const saveTemplate = () => {
            const name = prompt('Введите имя шаблона:');
            if (!name) return;
            const data = {
                name: name,
                timestamp: new Date().toISOString(),
                activeProtocols: Array.from(selectedProtocols),
                activeTools: Array.from(selectedTools),
                activeMetaProtocols: Array.from(selectedMetaProtocols),
                core: currentCore
            };
            saveToDB(data)
                .then(() => {
                    showNotification(`Шаблон "${name}" сохранён!`);
                    loadTemplatesFromDB(); // Обновить список
                })
                .catch(err => {
                    console.error('Ошибка сохранения шаблона:', err);
                    alert('Не удалось сохранить шаблон.');
                });
        };

        const exportDB = () => {
            loadFromDB().then(data => {
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'neural_architect_db_export.json';
                a.click();
            }).catch(err => {
                console.error('Ошибка экспорта БД:', err);
                alert('Не удалось экспортировать БД.');
            });
        };

        const clearDB = () => {
            if (!confirm('Вы уверены, что хотите очистить всю базу данных?')) return;
            const transaction = db.transaction([STORE_NAME], 'readwrite');
            const store = transaction.objectStore(STORE_NAME);
            const request = store.clear();
            request.onsuccess = () => {
                showNotification('База данных очищена.');
                loadTemplatesFromDB(); // Обновить список
            };
            request.onerror = () => {
                console.error('Ошибка очистки БД:', request.error);
                alert('Не удалось очистить БД.');
            };
        };
        // --- /НОВОЕ ---

        // --- ИНИЦИАЛИЗАЦИЯ ---
        document.addEventListener('DOMContentLoaded', async () => {
            await openDB(); // Ждем открытия БД
            renderTabs();
            renderMetaProtocols(); // НОВОЕ
            renderProtocols();
            renderTools();
            document.getElementById('search-input').addEventListener('input', (e) => {
                const value = e.target.value;
                renderProtocols(value);
                renderTools(value);
            });
            document.getElementById('copy-btn').addEventListener('click', copyToClipboard);
            document.getElementById('export-btn').addEventListener('click', exportJSON);
            document.getElementById('reset-btn').addEventListener('click', resetAll);
            document.getElementById('auto-select-btn').addEventListener('click', autoSelect);
            document.getElementById('encode-btn').addEventListener('click', encodeBase64);
            document.getElementById('decode-btn').addEventListener('click', decodeBase64);
            document.querySelectorAll('.preset-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const preset = btn.getAttribute('data-preset');
                    applyPreset(preset);
                });
            });
            // НОВОЕ: Обработчики умных пресетов
            document.querySelectorAll('.smart-preset').forEach(btn => {
                btn.addEventListener('click', () => {
                    const preset = btn.getAttribute('data-smart-preset');
                    applySmartPreset(preset);
                });
            });
            // НОВОЕ: Обработчики ядра
            document.querySelectorAll('.core-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const coreId = btn.getAttribute('data-core');
                    toggleCore(coreId);
                });
            });
            // НОВОЕ: API
            document.getElementById('toggle-api-btn').addEventListener('click', toggleApiSettings);
            document.getElementById('send-api-btn').addEventListener('click', sendToApi);
            // НОВОЕ: Рейтинг
            document.querySelectorAll('input[name="rating"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    submitRating(this.value);
                });
            });
            // НОВОЕ: База данных
            document.getElementById('save-template-btn').addEventListener('click', saveTemplate);
            document.getElementById('export-db-btn').addEventListener('click', exportDB);
            document.getElementById('clear-db-btn').addEventListener('click', clearDB);
            document.getElementById('load-template-btn').addEventListener('click', () => {
                // Клик по заголовку "Моя База" уже вызывает перезагрузку списка
                // Можно добавить модальное окно выбора, но для простоты обновим список
                loadTemplatesFromDB();
                showNotification('Список шаблонов обновлён.');
            });
            document.getElementById('tools-help').addEventListener('click', openHelpModal);
            document.getElementById('prompt-help').addEventListener('click', openHelpModal);
            document.getElementById('close-help').addEventListener('click', closeHelpModal);
            const statusIndicator = document.getElementById('system-status');
            const statusText = document.getElementById('status-text');
            setInterval(() => {
                statusIndicator.classList.toggle('active');
                statusText.textContent = statusIndicator.classList.contains('active') ? 'АКТИВЕН' : 'ГОТОВ';
            }, 2000);
        });
    </script>
</body>
</html>